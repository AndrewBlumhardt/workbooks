{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "025b9662-034f-4ba1-b416-fb18bd936073",
            "version": "KqlParameterItem/1.0",
            "name": "Status",
            "label": "Status Filter",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n  {\\r\\n    \\\"value\\\": \\\"Missing\\\",\\r\\n    \\\"label\\\": \\\"Missing\\\"\\r\\n  },\\r\\n  {\\r\\n    \\\"value\\\": \\\"Active\\\",\\r\\n    \\\"label\\\": \\\"Active\\\"\\r\\n  },\\r\\n  {\\r\\n    \\\"value\\\": \\\"Inactive\\\",\\r\\n    \\\"label\\\": \\\"Inactive\\\"\\r\\n  },\\r\\n  {\\r\\n    \\\"value\\\": \\\"Insufficient Info\\\",\\r\\n    \\\"label\\\": \\\"Insufficient Info\\\"\\r\\n  }\\r\\n]\\r\\n\",\"transformers\":null}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 8
          },
          {
            "id": "7b2e035f-7828-4ea8-9718-9a9e1daeecac",
            "version": "KqlParameterItem/1.0",
            "name": "showHelp",
            "label": "Show Help",
            "type": 2,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n  {\r\n    \"value\": \"Yes\",\r\n    \"label\": \"Yes\"\r\n  },\r\n  {\r\n    \"value\": \"Noa\",\r\n    \"label\": \"No\"\r\n  }\r\n]\r\n",
            "value": "Noa"
          },
          {
            "id": "10b0a4e8-330a-4021-9c3f-f00dc27ada4c",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "description": "Select your primary Sentinel workspace",
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| order by name asc\r\n| summarize Selected = makelist(id, 10), All = makelist(id, 1000)\r\n| mvexpand All limit 1000\r\n| project value = tostring(All), label = tostring(All), selected = iff(Selected contains All, true, false)",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": ""
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "ShowAll",
            "label": "Show All VMs Below",
            "type": 2,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n  {\r\n    \"value\": \"Yes\",\r\n    \"label\": \"Yes\"\r\n  },\r\n  {\r\n    \"value\": \"Noa\",\r\n    \"label\": \"No\"\r\n  }\r\n]\r\n",
            "value": "Noa",
            "id": "3e572416-a65b-4c61-941e-3b8da606de8d"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 1"
    },
    {
      "type": 1,
      "content": {
        "json": "### **About This Report**\r\n\r\nThis report helps verify Microsoft Defender for Endpoint (MDE) activation on Azure VMs and Azure Arc-enabled servers. It compares Azure activity data against MDE device records to identify which machines are active and properly protected.\r\n\r\n### **How the Report Works**\r\n\r\nThis report uses a two-part approach because MDE and Azure Resource data cannot be queried together directly.\r\n\r\n*   **Activity-Based Matching**: The report first finds all VMs with recorded Azure activity in the last 30 days. It then checks this list against MDE device information to determine activation status.\r\n*   **Inactive VMs**: A VM might be missing from the top table if it has had no Azure activity recently. Generally, active VMs record activity regularly. The bottom table provides a complete view of all VMs regardless of activity.\r\n\r\n### **Using the Tables**\r\n\r\nThis report contains two main tables:\r\n\r\n1.  **Active VMs with MDE Status (Top Table)**\r\n    *   **Content**: Shows VMs with Azure activity in the past 30 days, highlighting MDE and Microsoft Defender Antivirus status.\r\n    *   **Interactivity**: Use the status filter above this table to narrow results. Selecting one or more VMs in this table will filter the bottom table to show only those selected machines.\r\n\r\n2.  **All Tenant VMs (Bottom Table)**\r\n    *   **Content**: Shows only selected Azure VMs and Arc-enabled servers visible with your current permissions.\r\n    *   **Interactivity**: This table is automatically filtered when you select VMs in the top table, allowing for a detailed drill-down view.\r\n\r\n### **Troubleshooting Onboarding Issues**\r\n\r\nMDE activation can fail for several reasons. Defender for Cloud should automatically onboard Azure VMs when Defender for Servers is enabled, but issues can still occur.\r\n\r\n### **Troubleshooting MDE Onboarding Issues**\r\n\r\nDefender for Cloud should automatically onboard Azure VMs when Defender for Servers is enabled, but issues can occur. The sections below describe common failure points and how to resolve them.\r\n\r\n#### 1. Onboarding Conflict\r\nA VM can be healthy in MDE even if the automated Defender for Cloud extension shows a \"Failed\" state. This happens when the VM was onboarded to MDE using a direct method (like a script or GPO) while the Azure VM Guest Agent was not working.\r\n\r\nThe result is a healthy MDE sensor, but a failed Azure extension. The failed extension is a symptom of a broken Azure VM Guest Agent, which should be investigated separately as it impacts all VM management functions, not just MDE.\r\n\r\n#### 2. Defender for Servers Disabled\r\nThe subscription hosting the VM does not have Microsoft Defender for Servers enabled. While direct onboarding is possible, MDE for Servers requires a Defender for Servers Plan 1 or Plan 2 license to be compliant.\r\n\r\n*   **Resolution**: Enable Defender for Servers on the subscription or, for temporary use cases, onboard the VM directly.\r\n\r\n#### 3. Missing or Failed MDE Extension\r\nThe VM is missing the MDE onboarding extension, or the extension repeatedly fails. The Azure VM Guest Agent is typically missing or unresponsive due to its initial exclusion from a custom VM image, corruption of its service, or resource exhaustion from a non-standard server workload. The VM Agent is the critical process that allows Azure to manage the VM and deploy extensions.\r\n\r\n*   **How to Reinstall the Azure VM Guest Agent**:\r\n    If you suspect the agent is corrupted, reinstalling it can resolve the issue.\r\n\r\n    **For Windows:**\r\n    1.  First, obtain the latest Windows Azure VM Agent MSI package. You can find this by searching online for \"Windows Azure VM Agent download\". https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/agent-windows\r\n    2.  Save the MSI file to the VM and run the following from an elevated Command Prompt to install it quietly:\r\n        ```\r\n        msiexec.exe /i WindowsAzureVmAgent.msi /quiet /L*v C:\\AzureVmAgentInstall.log\r\n        ```\r\n\r\n    **For Linux (Debian/Ubuntu):**\r\n    Run the following commands to remove and then reinstall the agent.\r\n    ```bash\r\n    # Remove the existing agent\r\n    sudo apt-get -y remove walinuxagent\r\n\r\n    # Reinstall the agent\r\n    sudo apt-get -y install walinuxagent\r\n    ```\r\n\r\n    **For Linux (RHEL/CentOS/Oracle):**\r\n    Run the following commands to remove and then reinstall the agent.\r\n    ```bash\r\n    # Remove the existing agent\r\n    sudo yum -y remove waagent\r\n\r\n    # Reinstall the agent\r\n    sudo yum -y install waagent\r\n    ```\r\n\r\n#### 4. Failed MDE Extension (Temporary)\r\nThe MDE extension was deployed but failed to install or run. This can be caused by a temporary issue, such as a file lock or a pending reboot.\r\n*   **Resolution**: From the VM's \"Extensions + applications\" page in the Azure portal, find the MDE extension (`MDE.Windows` or `MDE.Linux`) and uninstall it. Wait for Defender for Cloud to automatically attempt to redeploy it.\r\n\r\n#### 5. Local OS or Network Issue\r\nA problem on the VM itself is preventing the MDE sensor from activating. This could be a conflict with other software, a previous onboarding to a different MDE tenant, or a local policy that forcibly disables the MDE service.\r\n*   **Resolution**: This requires interactive troubleshooting on the VM. It may be necessary to run the official MDE offboarding script to completely remove all traces of the sensor before attempting to onboard it again."
      },
      "conditionalVisibility": {
        "parameterName": "showHelp",
        "comparison": "isEqualTo",
        "value": "Yes"
      },
      "name": "text - 4"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AzureActivity\r\n| where TimeGenerated > ago(30d)\r\n| where ResourceProviderValue == \"MICROSOFT.COMPUTE\"\r\n| where _ResourceId contains \"/virtualmachines/\" and _ResourceId !contains \"extensions/\" and _ResourceId !contains \"virtualmachinescaleset\"\r\n| extend Parts = split(_ResourceId, \"/\")\r\n| extend _ResourceId = tolower(tostring(strcat_array(array_slice(Parts, 0, 8), \"/\")))\r\n| summarize arg_max(TimeGenerated, *) by _ResourceId\r\n| project AzureResourceId = _ResourceId\r\n| join kind=leftouter (\r\n    DeviceInfo\r\n    | where TimeGenerated > ago(15d)\r\n    | where isnotempty(AzureResourceId)\r\n    | summarize arg_max(TimeGenerated, *) by AzureResourceId\r\n    | project TimeGenerated, DeviceName, DeviceId, IsAzureADJoined, MachineGroup, OSPlatform, OnboardingStatus, SensorHealthState, AzureResourceId = tolower(tostring(AzureResourceId))\r\n) on AzureResourceId\r\n| extend ResourceName = tostring(split(AzureResourceId, \"/\").[-1])\r\n| extend MDE_Status = case(isempty( DeviceId), \"Missing\", isempty(SensorHealthState), OnboardingStatus, SensorHealthState)\r\n| project TimeGenerated, ViurtualMachine=AzureResourceId, DeviceName, OSPlatform, MDE_Status, OnboardingStatus, DeviceId, IsAzureADJoined, MachineGroup\r\n| where MDE_Status in ({Status})\r\n| summarize arg_max(TimeGenerated, *) by ViurtualMachine\r\n| summarize count() by MDE_Status",
        "size": 4,
        "title": "MDE Onboarding Status",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "visualization": "piechart",
        "tileSettings": {
          "showBorder": false
        }
      },
      "customWidth": "50",
      "name": "query - 5"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where (type =~ \"microsoft.hybridcompute/machines\" and kind =~ \"AVS\") or type =~ \"microsoft.compute/virtualmachines\"\r\n| join kind=leftouter (\r\n    resources\r\n    | where type endswith '/extensions' and name in ('MDE.Windows', 'MDE.Linux')\r\n    | extend parentId = substring(id, 0, indexof(id, '/extensions'))\r\n    | project MdeName = name, MdeStatus = tostring(properties.provisioningState), parentId\r\n) on $left.id == $right.parentId\r\n| extend  provisioningState = properties.provisioningState\r\n| extend  vmSize = properties.hardwareProfile.vmSize\r\n| extend  computerName = properties.osProfile.computerName\r\n| extend  adminUsername = properties.osProfile.adminUsername\r\n| extend  provisionVMAgent = properties.osProfile.windowsConfiguration.provisionVMAgent\r\n| extend  enableAutomaticUpdates = properties.osProfile.windowsConfiguration.enableAutomaticUpdates\r\n| extend  timeCreated = properties.timeCreated\r\n| extend  secureBootEnabled = properties.securityProfile.uefiSettings.secureBootEnabled\r\n| extend  osName = properties.extended.instanceView.osName\r\n| extend  displayStatus = properties.extended.instanceView.powerState.displayStatus\r\n| extend  licenseType = properties.licenseType\r\n| extend  osName = iif(isnull( osName), licenseType, osName)\r\n| extend MdeName = iif(isempty( MdeName), \"Missing\", MdeName)\r\n| extend MdeStatus = iif(isempty( MdeStatus), \"Missing\", MdeStatus)\r\n| extend id = tolower(id)\r\n| project vmName=id, computerName, Extension=MdeName, ExtStatus=MdeStatus, provisionVMAgent, enableAutomaticUpdates, secureBootEnabled, displayStatus, osName,  subscriptionId, location, provisioningState, vmSize, adminUsername, ['tags']\r\n| summarize count() by Extension",
        "size": 4,
        "title": "MDE Extension Status",
        "queryType": 1,
        "resourceType": "microsoft.resources/tenants",
        "crossComponentResources": [
          "value::tenant"
        ],
        "visualization": "piechart"
      },
      "customWidth": "50",
      "name": "query - 6"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AzureActivity\r\n| where TimeGenerated > ago(30d)\r\n| where ResourceProviderValue == \"MICROSOFT.COMPUTE\"\r\n| where _ResourceId contains \"/virtualmachines/\" and _ResourceId !contains \"extensions/\" and _ResourceId !contains \"virtualmachinescaleset\"\r\n| extend Parts = split(_ResourceId, \"/\")\r\n| extend _ResourceId = tolower(tostring(strcat_array(array_slice(Parts, 0, 8), \"/\")))\r\n| summarize arg_max(TimeGenerated, *) by _ResourceId\r\n| project AzureResourceId = _ResourceId\r\n| join kind=leftouter (\r\n    DeviceInfo\r\n    | where TimeGenerated > ago(15d)\r\n    | where isnotempty(AzureResourceId)\r\n    | summarize arg_max(TimeGenerated, *) by AzureResourceId\r\n    | project TimeGenerated, DeviceName, DeviceId, IsAzureADJoined, MachineGroup, OSPlatform, OnboardingStatus, SensorHealthState, AzureResourceId = tolower(tostring(AzureResourceId))\r\n) on AzureResourceId\r\n| extend ResourceName = tostring(split(AzureResourceId, \"/\").[-1])\r\n| extend MDE_Status = case(isempty( DeviceId), \"Missing\", isempty(SensorHealthState), OnboardingStatus, SensorHealthState)\r\n| project TimeGenerated, ViurtualMachine=AzureResourceId, DeviceName, OSPlatform, MDE_Status, OnboardingStatus, DeviceId, IsAzureADJoined, MachineGroup\r\n| where MDE_Status in ({Status})\r\n| summarize arg_max(TimeGenerated, *) by ViurtualMachine",
        "size": 0,
        "showAnalytics": true,
        "title": "Verification of MDE Onboarding for Azure VMs",
        "exportMultipleValues": true,
        "exportedParameters": [
          {
            "fieldName": "ViurtualMachine",
            "parameterName": "VerifyVM",
            "parameterType": 1
          }
        ],
        "showExportToExcel": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "ViurtualMachine",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "TimeGenerated",
              "formatter": 5
            },
            {
              "columnMatch": "DeviceName",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "OSPlatform",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "MDE_Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "!=",
                    "thresholdValue": "Active",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "18ch"
              }
            },
            {
              "columnMatch": "OnboardingStatus",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "!=",
                    "thresholdValue": "Onboarded",
                    "representation": "2",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "success",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "18ch"
              }
            },
            {
              "columnMatch": "DeviceId",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "IsAzureADJoined",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "MachineGroup",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            }
          ],
          "rowLimit": 10000,
          "filter": true
        }
      },
      "showPin": true,
      "name": "query - 0"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where (type =~ \"microsoft.hybridcompute/machines\" and kind =~ \"AVS\") or type =~ \"microsoft.compute/virtualmachines\"\r\n| join kind=leftouter (\r\n    resources\r\n    | where type endswith '/extensions' and name in ('MDE.Windows', 'MDE.Linux')\r\n    | extend parentId = substring(id, 0, indexof(id, '/extensions'))\r\n    | project MdeName = name, MdeStatus = tostring(properties.provisioningState), parentId\r\n) on $left.id == $right.parentId\r\n| extend  provisioningState = properties.provisioningState\r\n| extend  vmSize = properties.hardwareProfile.vmSize\r\n| extend  computerName = properties.osProfile.computerName\r\n| extend  adminUsername = properties.osProfile.adminUsername\r\n| extend  provisionVMAgent = properties.osProfile.windowsConfiguration.provisionVMAgent\r\n| extend  enableAutomaticUpdates = properties.osProfile.windowsConfiguration.enableAutomaticUpdates\r\n| extend  timeCreated = properties.timeCreated\r\n| extend  secureBootEnabled = properties.securityProfile.uefiSettings.secureBootEnabled\r\n| extend  osName = properties.extended.instanceView.osName\r\n| extend  displayStatus = properties.extended.instanceView.powerState.displayStatus\r\n| extend  licenseType = properties.licenseType\r\n| extend  osName = iif(isnull( osName), licenseType, osName)\r\n| extend MdeName = iif(isempty( MdeName), \"Missing\", MdeName)\r\n| extend MdeStatus = iif(isempty( MdeStatus), \"Missing\", MdeStatus)\r\n| extend id = tolower(id)\r\n| project vmName=id, computerName, Extension=MdeName, ExtStatus=MdeStatus, provisionVMAgent, enableAutomaticUpdates, secureBootEnabled, displayStatus, osName,  subscriptionId, location, provisioningState, vmSize, adminUsername, ['tags']\r\n| where vmName in ({VerifyVM})",
        "size": 0,
        "showAnalytics": true,
        "title": "Azure Resource Graph  - VM Details (Verify MDE Extension)",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resources/tenants",
        "crossComponentResources": [
          "value::tenant"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "vmName",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "computerName",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "Extension",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "thresholdValue": "MDE",
                    "representation": "Resolved",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "ExtStatus",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Succeeded",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "provisionVMAgent",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "true",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "enableAutomaticUpdates",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "true",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "secureBootEnabled",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "true",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "displayStatus",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "VM running",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "stopped",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "osName",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "subscriptionId",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "location",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "provisioningState",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "vmSize",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "adminUsername",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            }
          ],
          "rowLimit": 10000
        }
      },
      "conditionalVisibility": {
        "parameterName": "VerifyVM",
        "comparison": "isNotEqualTo"
      },
      "showPin": true,
      "name": "Azure Resource Graph  - VM Details"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "resources\r\n| where (type =~ \"microsoft.hybridcompute/machines\" and kind =~ \"AVS\") or type =~ \"microsoft.compute/virtualmachines\"\r\n| join kind=leftouter (\r\n    resources\r\n    | where type endswith '/extensions' and name in ('MDE.Windows', 'MDE.Linux')\r\n    | extend parentId = substring(id, 0, indexof(id, '/extensions'))\r\n    | project MdeName = name, MdeStatus = tostring(properties.provisioningState), parentId\r\n) on $left.id == $right.parentId\r\n| extend  provisioningState = properties.provisioningState\r\n| extend  vmSize = properties.hardwareProfile.vmSize\r\n| extend  computerName = properties.osProfile.computerName\r\n| extend  adminUsername = properties.osProfile.adminUsername\r\n| extend  provisionVMAgent = properties.osProfile.windowsConfiguration.provisionVMAgent\r\n| extend  enableAutomaticUpdates = properties.osProfile.windowsConfiguration.enableAutomaticUpdates\r\n| extend  timeCreated = properties.timeCreated\r\n| extend  secureBootEnabled = properties.securityProfile.uefiSettings.secureBootEnabled\r\n| extend  osName = properties.extended.instanceView.osName\r\n| extend  displayStatus = properties.extended.instanceView.powerState.displayStatus\r\n| extend  licenseType = properties.licenseType\r\n| extend  osName = iif(isnull( osName), licenseType, osName)\r\n| extend MdeName = iif(isempty( MdeName), \"Missing\", MdeName)\r\n| extend MdeStatus = iif(isempty( MdeStatus), \"Missing\", MdeStatus)\r\n| extend id = tolower(id)\r\n| project vmName=id, computerName, Extension=MdeName, ExtStatus=MdeStatus, provisionVMAgent, enableAutomaticUpdates, secureBootEnabled, displayStatus, osName,  subscriptionId, location, provisioningState, vmSize, adminUsername, ['tags']",
        "size": 0,
        "showAnalytics": true,
        "title": "Azure Resource Graph  - VM Details (Full Unfiltered)",
        "showExportToExcel": true,
        "queryType": 1,
        "resourceType": "microsoft.resources/tenants",
        "crossComponentResources": [
          "value::tenant"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "vmName",
              "formatter": 0,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "computerName",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "Extension",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "thresholdValue": "MDE",
                    "representation": "Resolved",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "ExtStatus",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Succeeded",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "provisionVMAgent",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "true",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "enableAutomaticUpdates",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "true",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "secureBootEnabled",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "true",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "warning",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "displayStatus",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "VM running",
                    "representation": "success",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "stopped",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "osName",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "subscriptionId",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            },
            {
              "columnMatch": "location",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "provisioningState",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "vmSize",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "14ch"
              }
            },
            {
              "columnMatch": "adminUsername",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "22ch"
              }
            }
          ],
          "rowLimit": 10000
        }
      },
      "conditionalVisibility": {
        "parameterName": "ShowAll",
        "comparison": "isEqualTo",
        "value": "Yes"
      },
      "showPin": true,
      "name": "Azure Resource Graph  - VM Details - Copy"
    }
  ],
  "fallbackResourceIds": [
    ""
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}